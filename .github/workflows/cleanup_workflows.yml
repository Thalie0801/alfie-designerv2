name: Quality Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: quality-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  NODE_VERSION: '20'

jobs:
  quality:
    name: TypeScript & Lint & Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Force public npm registry
        run: npm config set registry https://registry.npmjs.org/

      - name: Install dependencies (robuste)
        run: |
          set -euxo pipefail
          if [ -f package-lock.json ]; then
            npm ci --prefer-offline --no-audit --no-fund \
            || npm ci --prefer-offline --no-audit --no-fund --legacy-peer-deps \
            || npm install --prefer-online --no-audit --no-fund --legacy-peer-deps
          else
            npm install --prefer-online --no-audit --no-fund --legacy-peer-deps
          fi

      - name: TypeScript check
        run: npm run typecheck

      - name: Lint check (fallback JS-only si parser TS absent)
        run: |
          set -o pipefail
          node -e "try{require.resolve('@typescript-eslint/parser');process.exit(0)}catch{process.exit(1)}"
          if [ $? -eq 0 ]; then
            echo "Lint complet (TS+JS)"
            npm run lint -- --max-warnings=0
          else
            echo "::warning::@typescript-eslint/parser indisponible â†’ fallback JS-only"
            npx eslint . --ext .js,.jsx --no-eslintrc \
              --ignore-pattern '**/*.{ts,tsx}' \
              --rule 'no-redeclare:error' \
              --rule 'no-duplicate-imports:error' \
              --rule 'no-unused-vars:warn' \
              --rule 'no-console:warn' \
              --rule 'eqeqeq:warn'
          fi

      - name: Build
        run: npm run build

  database:
    name: Database Checks (basic)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Validate SQL migrations (syntax hints)
        run: |
          set -e
          if [ -d "supabase/migrations" ]; then
            ls -1 supabase/migrations/*.sql 2>/dev/null | while read -r file; do
              echo "Scanning $file"
              grep -E "(CREATE|ALTER|DROP) (TABLE|FUNCTION|POLICY|VIEW)" "$file" || true
            done
          else
            echo "No supabase/migrations directory."
          fi

