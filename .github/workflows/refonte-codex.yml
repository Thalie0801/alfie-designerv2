name: refonte-codex

on:
  workflow_dispatch: {}
  push:
    branches: [ main, refonte-alfie-2025 ]
  pull_request:
    branches: [ main, refonte-alfie-2025 ]

permissions:
  contents: read

jobs:
  codex:
    name: codex
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # (Optionnel) garde-fou: n'affiche qu'un warning si la landing est touchée
      - name: Guard (no landing changes) — non-blocking
        shell: bash
        run: |
          set -eo pipefail
          CHANGED="$(git -c core.quotepath=false status --porcelain || true)"
          if [ -z "$CHANGED" ]; then
            echo "OK: no changes."
            exit 0
          fi
          FILES="$(echo "$CHANGED" | awk '
            $1 ~ /^\?\?/ { $1=""; sub(/^ +/,""); print; next }
            $1 ~ /^R/   { match($0, /-> (.*)$/, m); if (m[1]!="") print m[1]; next }
            { $1=""; sub(/^ +/,""); print }')"
          if echo "$FILES" | grep -E -q '^(apps/landing/|www/|site/)'; then
            echo "::warning::Landing paths changed (apps/landing, www, site)."
          else
            echo "OK: no landing changes."
          fi

      # Step neutre pour garantir un job vert
      - name: Done
        run: echo "Refonte-codex: OK (no PR creation, no build)."
tion, no build)."
